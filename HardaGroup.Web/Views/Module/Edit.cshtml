@using HardaGroup.Utility;
@using HardaGroup.Models;
@{
    Layout = null;
    var module = (M_ModuleSearch)ViewData["ModuleSearch"];
}
<div class="close-modal" data-dismiss="modal">
    <i class="fa fa-3x fa-close"></i>
</div>
<div class="container">

    <h3 class="customer-h3 text-center curd-title">修 改</h3>
    <hr />
    <div class="form-horizontal">
        
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">URL唯一标识：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbModuleUrlId" style="width:40%" placeholder="只能是字母、数字或 - 组成" value="@module.ModuleURLId" />
                <input class="btn btn-default" id="btnGenerateNewUrlId" type="button" style="width:9%" value="自动生成" />
            </div>
        </div>
        <div class="form-group hide">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">标题：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbTitle" placeholder="标题" value="@module.Title"/>
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">标题：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbSubTitle" placeholder="标题" value="@module.SubTitle" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">内容简介：</label>
            </div>
            <div class="col-md-10">
                <textarea class="textarea-large" id="taDescription">@module.Description</textarea>
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">顺 序：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbSequence" placeholder="顺序" value="@module.Sequence" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">图片Class：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbImageClass" placeholder="图片Class" value="@module.ImageClass" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">内容简介：</label>
            </div>
            <div class="col-md-10">
                <textarea class="textarea-large" id="taDescription">@module.Description</textarea>
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">图 标：</label>
            </div>
            <div class="col-md-10">
                <div id="uploadThumbnailsImage">选择图片</div>
                <span class="customer-content-sm" id="status"></span>
            </div>
            <div class="col-lg-4 col-md-6 col-md-offset-2" style="margin-top:10px;">
                @if (module.Image != null && !string.IsNullOrEmpty(module.Image.VirtualPath))
                {
                    <img class="img-responsive" id="showUploadImage" src="@module.Image.VirtualPath" alt="无图标" />

                }
                else
                {
                    <img class="img-responsive" id="showUploadImage" src="~/images/small_model.jpg" alt="无图标" />

                }

            </div>

        </div>
        
        <div class="form-group">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">是否链接：</label>
            </div>
            <div class="col-md-10" style="padding-top:5px;">
                <input type="radio" value="true" name="IsHref" /><label>是</label>
                <input type="radio" value="false" checked="checked" name="IsHref" style="margin-left:50px;" /><label>否</label>

            </div>
        </div>
        <div class="form-group" id="divHref" style="display:none;">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">链 接：</label>
            </div>
            <div class="col-md-10">
                <input class="input-large" id="tbHref" placeholder="链接" value="@module.Href" />
            </div>
        </div>

        <div class="form-group" id="divContent">
            <div class="col-md-2 control-label">
                <label class="customer-content-sm">内 容：</label>
            </div>
            <div class="col-md-10">
                <textarea id="taContent" name="content">@module.Content</textarea>

            </div>
        </div>

    </div>

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-lg btn-info"
            data-dismiss="modal">
        退 出
    </button>
    <button type="button" class="btn btn-lg btn-danger" onclick="SaveEdit()">
        保 存
    </button>
</div>

<link rel="stylesheet" type="text/css" href="~/Scripts/webuploader/webuploader.css">
<script src="~/Scripts/webuploader/webuploader.js"></script>


<script type="text/javascript">
    var editor = KindEditor.create('textarea[name="content"]',kindeditorConfig);

    $(function () {
        InitWebUploader();
        InitGenerateModuleUrlIdEvent();

        //是否链接事件
        $("[name='IsHref']").change(function () {
            ChangeHrefRadio();
        });

        //如果是链接，则选中链接选项
        var isHref = '@module.IsHref';
        if (isHref.toLowerCase() == "true") {
            $("input[type=radio][value=true]").attr("checked", 'checked');
            ChangeHrefRadio();
        }
    });

    function ChangeHrefRadio() {
        var isHref = $("input[name='IsHref']:checked").val();

        if (isHref == "true") {
            //如果是链接，则隐藏并且清空内容编辑框,显示Href输入框
            editor.html("");
            $("#divHref").show();
            $("#divContent").hide();

        } else {
            //如果不是链接，则隐藏并且清空Href输入框,显示内容编辑框
            $("#Href").val(" ");
            $("#divHref").hide();
            $("#divContent").show();
        }
    }

    var uploader;
    function InitWebUploader() {


        // 初始化Web Uploader
        uploader = WebUploader.create({
            auto: false,   // 选完文件后，是否自动上传。
            swf: '../Scripts/webuploader/Uploader.swf',
            server: '/Module/UploadThumbnailsImage',
            duplicate: true, //可重复上传同一文件
            pick: '#uploadThumbnailsImage',  // 选择文件的按钮。可选。内部根据当前运行是创建，可能是input元素，也可能是flash.
            compress: false, //图片不压缩
            accept: {           // 只允许选择图片文件。
                title: 'Images',
                extensions: 'gif,jpg,jpeg,bmp,png',
                mimeTypes: 'image/*'
            },
            multiple: false,
            fileSingleSizeLimit: 1 * 1024 * 1024, // 单个文件最大不能超过1 M
            thumb: {        //缩略图配置
                // 为空的话则保留原有图片格式。
                // 否则强制转换成指定的类型。
                type: ''

            }
        });
        uploader.on('fileQueued', function (file) {
            $("#status").html("");
            //生成预览图片
            uploader.makeThumb(file, function (error, src) {
                if (error) {
                    $("#showUploadImage").attr('alt', "预览错误");
                } else {
                    $("#showUploadImage").attr('src', src);
                }
            }, 1, 1);
        });

        uploader.on('startUpload', function () {

            //开始上传，添加遮罩
            //$("body").showLoading();
        });
        uploader.on('uploadFinished', function () {

            //图片上传成功后关闭对话框，刷新表格
            CloseEditScreen();
            //刷新表格
            RefreshTable();
            $("body").hideLoading();
        });

        uploader.on('error', function (handler) {

            //隐藏遮罩
            $("body").hideLoading();

            if (handler == "Q_EXCEED_NUM_LIMIT") {
                alert("超出最大张数");
            }
            if (handler == "F_DUPLICATE") {
                alert("文件重复");
            }
            if (handler == "F_EXCEED_SIZE") {
                $("#status").html("<lable style='color:red;'>图片大小不能超过1M</lable>");
            }
        });


        // 文件上传成功，给item添加成功class, 用样式标记上传成功。
        uploader.on('uploadSuccess', function (file, response) {

            if (response.Success == false || response.Success == "false") {

            } else {

            }

        });

        // 完成上传完了，成功或者失败，先删除进度条。
        uploader.on('uploadComplete', function (file) {
            //$('#' + file.id).find('.progress').remove();
            //隐藏遮罩
            //$("body").hideLoading();
        });
    }

    function UploadImage(moduleGlobalizationId,culture) {

        uploader.options.formData.moduleGlobalizationId = moduleGlobalizationId;
        uploader.options.formData.culture = culture;

        uploader.upload();
    }

    //修改或新增保存
    function SaveEdit() {

        $("body").showLoading();
        var saveObj = ConstructSaveObj();
        var jsonParam = JSON.stringify(saveObj);
        $.ajax({
            type: "POST",
            url: "/Module/SaveEdit",
            dataType: "json",
            data: jsonParam,
            async: false,   //同步
            success: function (message) {

                if (message.Success) {

                    var moduleGlobalization = JSON.parse(message.Content);
                    //上传图片
                    var moduleGlobalizationId = moduleGlobalization.Id;
                    var culture = moduleGlobalization.Culture;
                    UploadImage(moduleGlobalizationId, culture);

                } else {
                    $("body").hideLoading();

                    layer.alert(message.Content, {
                        skin: 'layui-layer-molv' //样式类名
                      , closeBtn: 0
                    });
                    return;
                }
            }
        });
    }


    //构造保存对象
    function ConstructSaveObj() {

        var moduleGlobalization = {
            ModuleId:'@module.Id',
            Title: $("#tbTitle").val(),
            SubTitle: $("#tbSubTitle").val(),
            Description: $("#taDescription").val(),
            IsHref: $("input[name='IsHref']:checked").val(),
            Href: $("#tbHref").val(),
            Content: editor.html(),
            Culture: '@module.Culture',
            ImageClass: $("#tbImageClass").val()
        };
        var arrModuleGlobalization = new Array();
        arrModuleGlobalization.push(moduleGlobalization);

        var obj = {
            Id: '@module.Id',
            ModuleUrlId: $("#tbModuleUrlId").val(),
            Sequence: $("#tbSequence").val(),
            Type: '@module.Type',
            ModuleGlobalizations: arrModuleGlobalization

        };

        return obj;
    }

    function InitGenerateModuleUrlIdEvent() {
        $("#btnGenerateNewUrlId").click(function () {

            $.ajax({
                type: "POST",
                url: "/Module/GenerateNewURLId",
                dataType: "json",
                async: false,   //同步
                success: function (message) {

                    if (message.Success) {

                        $("#tbModuleUrlId").val(message.ReturnStrId);

                    } else {
                        layer.alert(message.Content, {
                            skin: 'layui-layer-molv' //样式类名
                          , closeBtn: 0
                        });
                        return;
                    }
                }
            });
        });
    }


</script>


